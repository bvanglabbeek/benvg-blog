---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

// Generate all tag paths
export async function getStaticPaths() {
  const posts = await getCollection('blog');

  const tags = new Set();
  for (const post of posts) {
    (post.data.tags || []).forEach(tag => {
      tags.add(tag.toLowerCase().replace(/\s+/g, '-'));
    });
  }

  return Array.from(tags).map(tag => ({
    params: { tag }
  }));
}

// Get current tag from URL
const { tag } = Astro.params;
const posts = await getCollection('blog');

// Utility to normalize and match tag slugs
function toSlug(str) {
  return str.toLowerCase().replace(/\s+/g, '-');
}

// Filter posts by this tag
const filteredPosts = posts.filter(post =>
  (post.data.tags || []).some(t => toSlug(t) === tag)
);

const readableTag = tag.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
---

<Layout title={`Posts tagged: ${readableTag}`}>
  <section style="margin-top: 2rem;">
    <h1>{readableTag}</h1>

    {filteredPosts.length === 0 ? (
      <p>No posts found in this category.</p>
    ) : (
      <ul style="display: flex; flex-direction: column; gap: 2rem; padding: 0;">
        {filteredPosts.map(post => (
          <li style="list-style: none;">
            <a href={`/blog/${post.slug}`} style="text-decoration: none; color: inherit;">
              <article style="
                background: white;
                border: 1px solid #eee;
                border-radius: 12px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.05);
                overflow: hidden;
              ">
                {post.data.image && (
                  <img src={post.data.image} alt={post.data.title} style="width: 100%; height: auto;" />
                )}
                <div style="padding: 1.5rem;">
                  <h2>{post.data.title}</h2>
                  <p>{post.data.description}</p>
                  <a href={`/blog/${post.slug}`} style="
                    display: inline-block;
                    margin-top: 1rem;
                    background: #10b981;
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 6px;
                    font-weight: 600;
                    font-size: 0.9rem;
                  ">Read More</a>
                </div>
              </article>
            </a>
          </li>
        ))}
      </ul>
    )}
  </section>
</Layout>
